<%- include('../partials/header') %>

<div class="page-header">
  <div class="page-actions">
    <a href="/vehicles" class="btn btn-secondary">
      <i class="fas fa-arrow-left"></i> Back to List
    </a>
  </div>
</div>

<div class="vehicle-detail-container">
  <div class="vehicle-image-container">
    <div class="vehicle-name text-center">
      <% if (vehicle.name) { %>
        <div class="vehicle-nickname prominent"><%= vehicle.name %></div>
      <% } %>
      <h3><%= vehicle.brand %> <%= vehicle.model %> (<%= vehicle.year %>)</h3>
      <span class="vehicle-status-badge <%= vehicle.status === 'active' ? 'status-active' : vehicle.status === 'maintenance' ? 'status-maintenance' : 'status-retired' %>">
        <%= vehicle.status === 'active' ? 'Active' : vehicle.status === 'maintenance' ? 'In Maintenance' : 'Retired' %>
      </span>
      
      <!-- Información clave del vehículo encima de la imagen -->
      <div class="vehicle-key-info-top">
        <div class="key-info-row">
          <div class="vehicle-plate-top"><%= vehicle.plate %></div>
        </div>
        <div class="key-info-row">
          <div class="key-info-value-top"><%= vehicle.vin || 'VIN: Not registered' %></div>
        </div>
      </div>
    </div>

    <% if (vehicle.image) { %>
      <img src="<%= vehicle.image %>" alt="<%= vehicle.brand %> <%= vehicle.model %>" class="vehicle-detail-image">
    <% } else { %>
      <img src="/images/vehicles/default-vehicle.svg" alt="<%= vehicle.brand %> <%= vehicle.model %>" class="vehicle-detail-image">
    <% } %>
  </div>
  
  <div class="vehicle-info-container">
    <div class="card">
      <div class="card-header">
        <h3>Vehicle Information</h3>
      </div>
      <div class="card-body">
        <div class="detail-grid">
          <div class="detail-item">
            <span class="detail-label">Name:</span>
            <span class="detail-value"><%= vehicle.name || 'Not assigned' %></span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Brand:</span>
            <span class="detail-value highlight"><%= vehicle.brand %></span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Model:</span>
            <span class="detail-value highlight"><%= vehicle.model %></span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Type:</span>
            <span class="detail-value">
              <%= vehicle.type === 'car' ? 'Car' : 
                 vehicle.type === 'truck' ? 'Truck' : 
                 vehicle.type === 'van' ? 'Van' : 
                 vehicle.type === 'motorcycle' ? 'Motorcycle' : 'Other' %>
            </span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Year:</span>
            <span class="detail-value highlight"><%= vehicle.year %></span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Status:</span>
            <span class="detail-value"><%= vehicle.status === 'active' ? 'Active' : vehicle.status === 'maintenance' ? 'In Maintenance' : 'Retired' %></span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Last Maintenance:</span>
            <span class="detail-value"><%= vehicle.lastMaintenance ? new Date(vehicle.lastMaintenance).toLocaleDateString() : 'Not registered' %></span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Driver:</span>
            <span class="detail-value"><%= vehicle.driver || 'Not assigned' %></span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Fuel Type:</span>
            <span class="detail-value">
              <%= vehicle.fuelType === 'gasoline' ? 'Gasoline' : 
                 vehicle.fuelType === 'diesel' ? 'Diesel' : 
                 vehicle.fuelType === 'electric' ? 'Electric' : 
                 vehicle.fuelType === 'hybrid' ? 'Hybrid' : 'Other' %>
            </span>
          </div>
          
          <div class="detail-item">
            <span class="detail-label">Mileage:</span>
            <span class="detail-value"><%= vehicle.mileage.toLocaleString() %> km</span>
          </div>
        </div>
        
        <!-- Botones de acciones -->
        <div class="detail-actions mt-3">
          <a href="/vehicles/<%= vehicle.id %>/edit" class="btn btn-primary btn-sm">
            <i class="fas fa-edit"></i> Edit Vehicle
          </a>
          <a href="/maintenance/create?vehicleId=<%= vehicle.id %>" class="btn btn-success btn-sm">
            <i class="fas fa-tools"></i> Schedule Maintenance
          </a>
          <form action="/vehicles/<%= vehicle.id %>/delete" method="POST" class="delete-form" onsubmit="return confirm('¿Está seguro de eliminar este vehículo? Esta acción no se puede deshacer.');">
            <button type="submit" class="btn btn-danger btn-sm">
              <i class="fas fa-trash"></i> Delete Vehicle
            </button>
          </form>
        </div>
        
        <!-- Timestamps -->
        <div class="detail-timestamps">
          <div class="timestamp-row">
            <small><strong>Created:</strong> <%= new Date(vehicle.createdAt).toLocaleString() %></small>
          </div>
          <div class="timestamp-row">
            <small><strong>Updated:</strong> <%= new Date(vehicle.updatedAt).toLocaleString() %></small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sección de Mantenimientos -->
<div class="card mt-4">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h3>Maintenance Records</h3>
      <a href="/maintenance/create?vehicleId=<%= vehicle.id %>" class="btn btn-success btn-sm">
        <i class="fas fa-plus"></i> Schedule Maintenance
      </a>
    </div>
  </div>
  <div class="card-body">
    <% if (maintenanceRecords && maintenanceRecords.length > 0) { %>
      <!-- Filtros -->
      <div class="maintenance-filters mb-3">
        <div class="form-row">
          <div class="form-col">
            <label for="typeFilter">Service Type:</label>
            <select id="typeFilter" class="form-control">
              <option value="">All Types</option>
              <% if (serviceTypes && serviceTypes.length > 0) { %>
                <% serviceTypes.forEach(service => { %>
                  <option value="<%= service.id %>"><%= service.name %></option>
                <% }); %>
              <% } %>
            </select>
          </div>
          <div class="form-col">
            <label for="statusFilter">Status:</label>
            <select id="statusFilter" class="form-control">
              <option value="">All Statuses</option>
              <option value="scheduled">Scheduled</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="form-col">
            <label for="dateFilter">Date Range:</label>
            <div class="d-flex gap-2">
              <input type="date" id="dateFilterFrom" class="form-control" placeholder="From">
              <input type="date" id="dateFilterTo" class="form-control" placeholder="To">
            </div>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table" id="maintenanceTable">
          <thead>
            <tr>
              <th>Type</th>
              <th>Date</th>
              <th>Status</th>
              <th>Service Provider</th>
              <th>Cost</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% maintenanceRecords.forEach(record => { %>
              <tr data-type="<%= record.maintenanceType %>" data-status="<%= record.status %>" data-date="<%= record.scheduleDate %>">
                <td>
                  <% 
                  let serviceName = 'Other';
                  if (serviceTypes && serviceTypes.length > 0) {
                    const serviceType = serviceTypes.find(s => s.id === record.maintenanceType);
                    if (serviceType) {
                      serviceName = serviceType.name;
                    }
                  }
                  %>
                  <%= serviceName %>
                </td>
                <td><%= new Date(record.scheduleDate).toLocaleDateString() %></td>
                <td>
                  <span class="status-badge 
                    <%= record.status === 'scheduled' ? 'status-warning' : 
                       record.status === 'in_progress' ? 'status-primary' : 
                       record.status === 'completed' ? 'status-active' : 
                       'status-retired' %>">
                    <%= record.status === 'scheduled' ? 'Scheduled' : 
                       record.status === 'in_progress' ? 'In Progress' : 
                       record.status === 'completed' ? 'Completed' : 
                       'Cancelled' %>
                  </span>
                </td>
                <td><%= record.serviceProvider || 'N/A' %></td>
                <td><%= record.cost ? '$' + record.cost.toFixed(2) : 'N/A' %></td>
                <td class="action-cell">
                  <a href="/maintenance/<%= record.id %>" class="btn-icon text-primary" title="View details">
                    <i class="fas fa-eye"></i>
                  </a>
                  <a href="/maintenance/<%= record.id %>/edit" class="btn-icon text-warning" title="Edit">
                    <i class="fas fa-edit"></i>
                  </a>
                  <form action="/maintenance/<%= record.id %>/delete" method="POST" style="display: inline;">
                    <button type="submit" class="btn-icon text-danger" title="Delete" 
                            onclick="return confirm('Are you sure you want to delete this maintenance record?')">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      
      <div id="noRecordsMessage" style="display: none;" class="text-center mt-3">
        <p>No maintenance records match the selected filters.</p>
      </div>
    <% } else { %>
      <div class="text-center">
        <p>No maintenance records found for this vehicle.</p>
        <a href="/maintenance/create?vehicleId=<%= vehicle.id %>" class="btn btn-primary mt-2">
          <i class="fas fa-plus-circle"></i> Schedule First Maintenance
        </a>
      </div>
    <% } %>
  </div>
</div>

<script>
  // Filtrado de la tabla de mantenimientos
  document.addEventListener('DOMContentLoaded', function() {
    const typeFilter = document.getElementById('typeFilter');
    const statusFilter = document.getElementById('statusFilter');
    const dateFilterFrom = document.getElementById('dateFilterFrom');
    const dateFilterTo = document.getElementById('dateFilterTo');
    const table = document.getElementById('maintenanceTable');
    const noRecordsMessage = document.getElementById('noRecordsMessage');
    
    if (!table || !typeFilter || !statusFilter) return;
    
    const rows = table.querySelectorAll('tbody tr');
    
    function applyFilters() {
      const selectedType = typeFilter.value;
      const selectedStatus = statusFilter.value;
      const fromDate = dateFilterFrom.value ? new Date(dateFilterFrom.value) : null;
      const toDate = dateFilterTo.value ? new Date(dateFilterTo.value) : null;
      
      let visibleRows = 0;
      
      rows.forEach(row => {
        const rowType = row.getAttribute('data-type');
        const rowStatus = row.getAttribute('data-status');
        const rowDate = new Date(row.getAttribute('data-date'));
        
        // Aplicar filtros
        let showRow = true;
        
        if (selectedType && rowType !== selectedType) {
          showRow = false;
        }
        
        if (selectedStatus && rowStatus !== selectedStatus) {
          showRow = false;
        }
        
        if (fromDate && rowDate < fromDate) {
          showRow = false;
        }
        
        if (toDate) {
          // Ajustar la fecha "hasta" para incluir todo el día
          const adjustedToDate = new Date(toDate);
          adjustedToDate.setHours(23, 59, 59, 999);
          if (rowDate > adjustedToDate) {
            showRow = false;
          }
        }
        
        row.style.display = showRow ? '' : 'none';
        
        if (showRow) {
          visibleRows++;
        }
      });
      
      // Mostrar mensaje si no hay resultados
      if (visibleRows === 0 && rows.length > 0) {
        noRecordsMessage.style.display = 'block';
      } else {
        noRecordsMessage.style.display = 'none';
      }
    }
    
    // Agregar eventos de cambio a los filtros
    typeFilter.addEventListener('change', applyFilters);
    statusFilter.addEventListener('change', applyFilters);
    dateFilterFrom.addEventListener('change', applyFilters);
    dateFilterTo.addEventListener('change', applyFilters);
  });
</script>

<% if (maintenanceRecords && maintenanceRecords.length > 0) { %>
  <style>
    .maintenance-filters {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    
    .gap-2 {
      gap: 10px;
      display: flex;
    }
    
    .form-row {
      display: flex;
      flex-wrap: wrap;
      margin: 0 -10px;
    }
    
    .form-col {
      flex: 1;
      padding: 0 10px;
      min-width: 200px;
      margin-bottom: 10px;
    }
    
    @media (max-width: 768px) {
      .form-row {
        flex-direction: column;
      }
      
      .form-col {
        width: 100%;
      }
    }
  </style>
<% } %>

<%- include('../partials/footer') %> 